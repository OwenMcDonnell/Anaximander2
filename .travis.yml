language: csharp
solution: Source/Anaximander.sln

mono:
  - 4.6.1

cache:
  directories:
    - Source\packages

before_script:
  - if [ "$TRAVIS_TAG" ]; then export TAG_VERSION="$TRAVIS_TAG.$TRAVIS_BUILD_NUMBER"; else export TAG_VERSION="v2.0.0.$TRAVIS_BUILD_NUMBER"; fi
  - export TAG_VERSION=`echo $TAG_VERSION | sed 's/v//'`
  - echo "Setting version to '$TAG_VERSION'"
  - sed -i "s/1\.0\.\*/$TAG_VERSION/" Source/Anaximander/Properties/AssemblyInfo.cs
  - sed -i "s/1\.0\.\*/$TAG_VERSION/" Source/RollbarCrashReporter/Properties/AssemblyInfo.cs
  - sed -i 's/COMPILED_BY = "?mono?"/COMPILED_BY = "Mono"/' Source/Anaximander/Program.cs
  - sed -i 's/COMPILED_BY = "?mono?"/COMPILED_BY = "Mono"/' Source/RollbarCrashReporter/CrashReporter.cs

before_deploy:
  - >-
    if [ "$TRAVIS_TAG" ]; then
      export ENVIRONMENT=production
      sed -i 's/param name="Environment" value="development"/param name="Environment" value="production"/' bin/Anaximander.exe.config;
      sed -i 's/param name="Environment" value="development"/param name="Environment" value="production"/' bin/RollbarCrashReporter.exe.config;
    else
      export ENVIRONMENT=test
      sed -i 's/param name="Environment" value="development"/param name="Environment" value="test"/' bin/Anaximander.exe.config;
      sed -i 's/param name="Environment" value="development"/param name="Environment" value="test"/' bin/RollbarCrashReporter.exe.config;
    fi
  - mv bin Anaximander2
  - zip -r Anaximander2-mono.zip Anaximander2 > /dev/null

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: CKa5EyJd57xbTjj/MkVSnwn2adrfe3n3+MkTRcOx4aOEAvptcjuw7jOxD6iCX7f1CRmq8Nli1fffWHD7hs1EbtgvpSW0azfSxsIPqpOkY2BsyDfyUfWWNHgJY/MfiyuaU0iOuLzNHcfNz1c/uAVHfXuzvWtiRGy766lfoKutfwKQHg+ZkPkMAWu56JDytNcaHufUXbeAhdLC5PPxmamUbm6hrX2+YVg/W1e3WIbxcuaxwcAuzXw4m/OmCytAk4qFn1Zn33z3QRtJphsqfgctJSoaz9MlfiDhCPnFIpP744+Nj/exuk1X582om7NWiVn+4NztRgvmAiwnMTKzDi4P7DG6Zb5MFdpNEgku0TrjW6S/Jemg4XQidqCKoy8ATU1rP/2c/h/Bl81WDOIM8HwV2yL+4VZ5H+4c7kNpj4z8rsC0WEG0hWK7VouVMPTTbgSLZcb/79Bn4kEkqmu6nQMFXhC/6vA7FUUHb5hmRRenaWRraCwoYkk19B9wCDn3KnkdC8QglYApVQ+FuFX4IQ1TAuHlcPe0RQPWBDqYlJMJB8UloZ1zmY9eeMJc1tXUDvY6CNaiT1KoN86/cpFBe47mwoVnijVPo/U9q+cqHygXAeXnhwGgJo7CZ75cd2kn9q/Y1ygxZGadc1Q2CaMpmbwLzsx25CucMDViQpbkfnpGdtc=
  file: Anaximander2-mono.zip
  draft: true
  on:
    repo: kf6kjg/Anaximander2
    tags: true

after_deploy:
  - export LOCAL_USERNAME="`git log -n 1 --pretty=format:"%an"`"
  - export REVISION="`git log -n 1 --pretty=format:"%H"`"
  - curl https://api.rollbar.com/api/1/deploy/ -F access_token="$ACCESS_TOKEN" -F environment="$ENVIRONMENT" -F revision="$REVISION" -F local_username="$LOCAL_USERNAME"
